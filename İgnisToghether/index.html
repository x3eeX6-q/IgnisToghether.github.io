<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="images/favicon.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ä°gnis Toghether</title>
    <!-- Load React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Load Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .user-list { width: 280px; }
        .screen-container { flex: 1; }
        .controls { position: fixed; bottom: 1rem; right: 1rem; }
        .chat-container { height: 300px; }
        .messages { height: calc(100% - 60px); }
    </style>
</head>
<body>
    <div id="root">
        <div class="min-h-screen bg-gray-900">
            <!-- Login Screen -->
            <div id="login-screen" class="flex items-center justify-center min-h-screen">
                <div class="bg-gray-800 p-8 rounded-lg shadow-xl w-full max-w-md">
                    <h1 class="text-2xl font-bold text-white text-center mb-6">Join Stream Room</h1>
                    <input 
                        type="text" 
                        id="room-code" 
                        placeholder="Enter room code"
                        class="w-full px-4 py-3 rounded bg-gray-700 text-white border border-gray-600 focus:border-blue-500 focus:outline-none mb-4"
                    >
                    <button 
                        onclick="joinRoom()"
                        class="w-full bg-blue-500 text-white py-3 rounded font-semibold hover:bg-blue-600"
                    >
                        Join Room
                    </button>
                </div>
            </div>

            <!-- Room Screen (hidden by default) -->
            <div id="room-screen" class="hidden flex h-screen">
                <div class="screen-container p-4 flex flex-col">
                    <div class="flex-1 bg-black rounded-lg relative">
                        <video id="shared-screen" autoplay playsinline class="w-full h-full object-contain"></video>
                        <div id="no-screen-message" class="absolute inset-0 flex items-center justify-center text-white">
                            No one is sharing their screen
                        </div>
                    </div>
                    
                    <!-- Chat System -->
                    <div class="mt-4 bg-gray-800 rounded-lg chat-container">
                        <div id="messages" class="messages overflow-y-auto p-4 space-y-4">
                            <!-- Messages will be added here -->
                        </div>
                        <div class="p-4 border-t border-gray-700">
                            <form onsubmit="sendMessage(event)" class="flex gap-2">
                                <input 
                                    type="text" 
                                    id="message-input"
                                    placeholder="Type a message..."
                                    class="flex-1 bg-gray-700 text-white rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                >
                                <button 
                                    type="submit"
                                    class="bg-blue-500 text-white p-2 rounded hover:bg-blue-600"
                                >
                                    Send
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
                
                <div class="user-list bg-gray-800 p-4" id="user-list">
                    <!-- Users will be added here dynamically -->
                </div>

                <div class="controls flex gap-2">
                    <button onclick="toggleShare()" class="p-3 rounded-full bg-blue-500 text-white hover:opacity-90">
                        Share Screen
                    </button>
                    <button onclick="toggleMute()" class="p-3 rounded-full bg-blue-500 text-white hover:opacity-90">
                        Toggle Mute
                    </button>
                    <button onclick="leaveRoom()" class="p-3 rounded-full bg-red-500 text-white hover:opacity-90">
                        Leave
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let screenStream = null;
        let audioStream = null;
        const ROOM_CODE = '10KRL8dCNvQFjt3UqDz4KI';
        const messages = [];

        function joinRoom() {
            const code = document.getElementById('room-code').value;
            if (code === ROOM_CODE) {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('room-screen').classList.remove('hidden');
                initializeAudio();
                addUser('You (Host)');
                addMessage('System', 'Welcome to the room!');
            } else {
                alert('Invalid room code');
            }
        }

        function addUser(name) {
            const userList = document.getElementById('user-list');
            const userDiv = document.createElement('div');
            userDiv.className = 'flex items-center justify-between p-2 rounded bg-gray-700 mb-2';
            userDiv.innerHTML = `
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-gray-600"></div>
                    <span class="text-white text-sm">${name}</span>
                </div>
            `;
            userList.appendChild(userDiv);
        }

        function addMessage(sender, content) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex flex-col';
            messageDiv.innerHTML = `
                <span class="text-gray-400 text-sm">${sender}</span>
                <p class="text-white">${content}</p>
            `;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            // Store message
            messages.push({ sender, content, timestamp: new Date() });
        }

        function sendMessage(event) {
            event.preventDefault();
            const input = document.getElementById('message-input');
            const content = input.value.trim();
            
            if (content) {
                addMessage('You', content);
                input.value = '';
            }
        }

        async function toggleShare() {
            try {
                if (!screenStream) {
                    screenStream = await navigator.mediaDevices.getDisplayMedia({
                        video: true,
                        audio: true
                    });
                    const video = document.getElementById('shared-screen');
                    video.srcObject = screenStream;
                    document.getElementById('no-screen-message').style.display = 'none';
                    addMessage('System', 'You started sharing your screen');
                    
                    screenStream.getVideoTracks()[0].onended = () => {
                        stopSharing();
                    };
                } else {
                    stopSharing();
                }
            } catch (err) {
                console.error('Error sharing screen:', err);
                addMessage('System', 'Failed to share screen');
            }
        }

        function stopSharing() {
            if (screenStream) {
                screenStream.getTracks().forEach(track => track.stop());
                screenStream = null;
                document.getElementById('shared-screen').srcObject = null;
                document.getElementById('no-screen-message').style.display = 'flex';
                addMessage('System', 'Screen sharing stopped');
            }
        }

        async function initializeAudio() {
            try {
                audioStream = await navigator.mediaDevices.getUserMedia({
                    audio: true
                });
            } catch (err) {
                console.error('Error getting audio:', err);
                addMessage('System', 'Failed to initialize audio');
            }
        }

        function toggleMute() {
            if (audioStream) {
                const audioTrack = audioStream.getAudioTracks()[0];
                audioTrack.enabled = !audioTrack.enabled;
                addMessage('System', `You are now ${audioTrack.enabled ? 'unmuted' : 'muted'}`);
            }
        }

        function leaveRoom() {
            stopSharing();
            if (audioStream) {
                audioStream.getTracks().forEach(track => track.stop());
            }
            document.getElementById('room-screen').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('user-list').innerHTML = '';
            document.getElementById('messages').innerHTML = '';
            messages.length = 0; // Clear messages array
        }
    </script>
</body>
</html>